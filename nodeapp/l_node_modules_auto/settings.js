// with custom route 
//take name of last line module.exports.?????=main  // ????? is your custom name of your library , so change it after copying or using this template example to whatever your custom library should be named

var _ = require("lodash");
var $gl = require("../l_node_modules/global.js").gl; // this contanes some extra modules and standard library function that can be made to make life easier , please see help under nodejsVRTwebStdLib
//

var apiname="settings"

var main={ 
            auto_run : function(params){  // runs as the modules starts being initialised 
                console.log("auto_running " + apiname)
                
                
            },
            run_after_init : function(params){ // params : { http: http , io : io} // io = socket.io 

                

            }
            ,table : "../data/kcs/settings.json"
            ,tables : { 
                            type : "jsonfile",  
                            schema : {}, // empty all                          
                            all : [ {  name : "settings" , jfpath : "../data/db1/settings.json",
                                       schema_rec : {}
                                    }
                            ]
            },
            __app : [ // must be named __app to create a route
                {   
                    name  : "settings",
                    route : "/settings", // if route not included it will defualt to to name
                    type : "post", // get or post
                    cb : function(req, res, corestuff){ // or fn or callback that will run once route is called , // corestuff ,gives you some extra modules , parameters and values to use 
                        var tt=this
                        var bd=req.body

                        corestuff.mds.users.verifyLoginAPI({ req : req},function(vd){
                            if (vd.allowed){ // do something if token valid
                                    //console.log(JSON.stringify(vd.details,null,2))
                                    if (req.body.type==="get"){
                                        res.jsonp({ loggedin : true })
                                        return
                                    }
                                    if (req.body.type==="add"){
                                        res.jsonp({})
                                        return
                                    }
                                    
                                    if (req.body.type==="getLoginPage"){

                                        main.get_table(function(data){
                                            var nd={}
                                            nd.loginPage=data.loginPage
                                            nd.defPage=data.defPage
                                            nd.displayMenu=data.displayMenu
                                            //nd.menuStyle=data.menuStyle
                                            
                                        
                                            res.jsonp({ status : "success" , data : nd})    
                                        })
                                        
    
                                        return
                                    }

                                    
                                    res.jsonp({ "defualt" : "did nothing"})
                                    return
                                    
                            }else{ // no token included do something else
                                if (req.body.type==="get"){

                                    main.get_table(function(data){
                                        var nd={}
                                        nd.loginPage=data.loginPage
                                    
                                        res.jsonp({ status : "success" , data : nd})    
                                    })
                                    

                                    return
                                }

                                if (req.body.type==="getLoginPage"){

                                    main.get_table(function(data){
                                        var nd={}
                                        nd.loginPage=data.loginPage
                                        nd.defPage=data.defPage
                                        nd.displayMenu=data.displayMenu
                                        //nd.menuStyle=data.menuStyle

                                        res.jsonp({ status : "success" , data : nd})    
                                    })
                                    

                                    return
                                }

                                
                                

                                res.jsonp({ "defualt" : "did nothing"})
                                return
                            }
                        })
                    } 


                } // add as many routes as you want in this array, and change name and route string values to your liking
                
            ],
            get_table : function(cb){
                var tt=this
                 
                
                if (tt.tables.type==="jsonfile"){ 
                    var jsonfilepath= tt.tables.all[0].jfpath ;   
                   
                    $gl.get_json_db(   jsonfilepath  , function(alldata){
                        
                        cb(alldata)
                    })
                }

                if (tt.tables.type==="mongodb"){ 

                }

        
            },
            update_table : function(key, new_data, params, cb){ // ({}. { newdata }, {}, function(){} )
                var tt=this

                if (tt.tables.type==="jsonfile"){ 
                    var jsonfilepath= tt.tables.all[0].jfpath ;   
        
                    main.get_table(function(alldata){
                        var nr_temp=_.clone(tt.tables.all[0].schema)
                        
                        //_.each()

                        //_.each( new_data, function(){

                        //})

                        var nr=_.merge(nr_temp , new_data)

                        var haskey=false
                        var haskeydata=false // not empty check
                        if (!_.isUndefined(key)){
                            haskey=true
                            if (!_.isEmpty(key)){
                                haskeydata=true

                            }
                        }


                        // #todo , key update only
                        if (haskeydata){
                            var tempdataall=_.cloneDeep(alldata)

                            alldata=_.merge(tempdataall, new_data)

                            

                        }else{ // update merge all 
                            var nr=_.merge(nr_temp , new_data)
                            alldata=_.merge(tempdataall, new_data)

                            //var alldata path--> [key] = nr
                        }

                        $gl.save_json_db(jsonfilepath  , alldata , function(){                            
                            cb({})      
                            return  
                        })
        
                        
                    })
                }

                if (tt.tables.type==="mongodb"){ 

                }
                
            }
        
}


 
module.exports[apiname]=main;
 
