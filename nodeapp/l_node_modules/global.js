var path = require("path");
var fs = require("fs");

var child_process = require('child_process');
var os = require('os');

var _ = require("lodash");
var uuid = require('uuid').v1;
//const { resolveTxt } = require("node:dns");

var express =require('express');
var assert = require("assert");
var cookieParser = require('cookie-parser');
var csvparse = require('csv-parse')
const multer = require('multer');
var jwt = require("jsonwebtoken");
var cors = require('cors');
var readline=require('readline');
var http=require('http')
let SFTPClient = require('ssh2-sftp-client');

var mds={ 
    uuid : uuid, 
    express : express,
    http : http,
    fs : fs,   
    path : path,
    lodash : _,
    "_" : _ ,
    assert : assert,
    cookieParser : cookieParser,
    csvparse : csvparse,
    multer : multer,
    jsonwebtoken : jwt,
    cors : cors,
    readline : readline




}

var vrtstd=function(){
    l_this = {
        name : "vrtstd"
        ,mds : mds
        ,get_json_db : function(){
            var args=arguments;
            var args_l=args.length;

            var cb=()=>{};
            var file="";
            if (!_.isUndefined(args[0])){
            file=args[0];
            }

            if (!_.isUndefined(args[1])){
            cb=args[1];
            }

            fs.readFile(file, 'utf8', function (err, data) {
            if (err){ throw err; }
            ///////
                var db_json = JSON.parse(data);

            ///////

                cb(db_json);
            });
        }
        ,get_json_db_sync : function(){
            var args=arguments;
            var args_l=args.length;

            var cb=()=>{};
            var file="";
            if (!_.isUndefined(args[0])){
            file=args[0];
            }

            if (!_.isUndefined(args[1])){
            cb=args[1];
            }
            
            var file_data_s=fs.readFileSync( file , 'utf8');

            var fn1=function (err, data) {
                 if (err){ throw err; }
            ///////
                var db_json = JSON.parse(data);

            ///////

                cb(db_json);
            };
            fn1(undefined,file_data_s)
            return db_json
        }
        ,save_json_db : function(){
            var args=arguments;
            var args_l=args.length;

            var cb=()=>{};
            var file="";
            var data={};
            var text="";
            if (!_.isUndefined(args[0])){
            file=args[0];
            }
            if (!_.isUndefined(args[1])){
            data=args[1];
            if (_.isPlainObject(data)){
                text=JSON.stringify(data , null ,4)
            }else{
                text=data;
            }
            }

            if (!_.isUndefined(args[2])){
            cb=args[2];
            }
            
            fs.writeFile(file, text, function (err) {
            if (err){ throw err; }

                cb();
            });


        }
        ,save_file : function(){
            var args=arguments;
            var args_l=args.length;

            var cb=()=>{};
            var file="";
            var data="";
            var text="";
            if (!_.isUndefined(args[0])){
            file=args[0];
            }
            if (!_.isUndefined(args[1])){
            data=args[1];
            
            text=data
            }

            if (!_.isUndefined(args[2])){
            cb=args[2];
            }
            
            fs.writeFile(file, text, function (err) {
            if (err){ throw err; }

                cb();
            });


        }
        ,shell : function(){
                            // commnand ,  callback function
                            var l_val="";            
                            var l_args=arguments;
                            var l_args_len=l_args.length;
                            var l_callback=function(){} ;
                            var l_command = "" ;
                            var param_array = [] ;

                            if ( l_args_len > 0 ){
                                var l_i=0;
                                switch( typeof l_args[l_i] ){
                                        case "object" :
                                            if (l_args[l_i] instanceof Array ){
                                                //param_array=l_args[l_i];
                                            }else{
                                                // is object

                                            }

                                            break;
                                        case "function" :
                                            l_callback=l_args[l_i];
                                            break;
                                        default :
                                            l_command=l_args[l_i] ;
                                            break;
                                }

                                var l_i=1;
                                if ( l_args_len > l_i ){
                                    switch( typeof l_args[l_i] ){
                                        case "object" :
                                            if (l_args[l_i] instanceof Array ){
                                                param_array=l_args[l_i];
                                            }else{
                                                // is object

                                            }
                                            break;
                                        case "function" :
                                            l_callback=l_args[l_i];
                                            break;
                                        default :
                                            break;
                                    }
                                }

                                var l_i=2;
                                if ( l_args_len > l_i ){
                                    switch( typeof l_args[l_i] ){
                                        case "object" :
                                            if (l_args[l_i] instanceof Array ){

                                            }else{
                                                // is object

                                            }
                                            break;
                                        case "function" :
                                            l_callback=l_args[l_i];
                                            break;
                                        default :
                                            break ;
                                    }
                                }


                            }else{
                                return ;
                            }

                            //console.log( "....",param_array);

                            var l_exec=child_process.exec;
                            l_exec( l_command ,{maxBuffer: 1024 * 40000}, function(error, stdout, stderr){
                                if ( !(stdout==="" && error==="Error: Command failed") ){
                                    if (error) {
                                    console.error(`exec error...:${error}` , '~~~' );
                                    l_callback( `exec error...:${error}` );
                                    return;
                                    }
                                }

                                l_callback( stdout );
                            });

                            return ;
                            ////////// old code
                            //var command_data=child_process.spawn("ping localhost" , [  "localhost" ] ) ;
                            var command_data=child_process.spawn(l_command , param_array ) ;
                            command_data.stdout.on('data', function(data){                                
                                l_val="stdout: " +  data;
                                //result=l_val;
                                //res.send( l_val ) ;
                            });

                            command_data.on('exit', function(code){                                                                
                                l_callback( l_val.toString()) ;
                            });


                        }

        /*
        //ftp usage tests
        //$gl.sftp_get("/mnt/c/nodeproj/testdata/sftp/src/abc.txt", 
        //            "/mnt/c/nodeproj/testdata/sftp/dst/abc.txt", 
        $gl.sftp_getDir("/mnt/c/nodeproj/testdata/sftp/dst", 
                    "/mnt/c/nodeproj/testdata/sftp/src", 
        //$gl.sftp_putDir("/mnt/c/nodeproj/testdata/sftp/src", 
        //            "/mnt/c/nodeproj/testdata/sftp/dst", 
                    { ftp :{
                                host: '127.0.0.1',
                                port: '22',
                                username: '',
                                password: '' 
                            }
                    } , 
                    function(){ console.log("ftp done") } 
        )
        */
        ,sftp_get : function(src , dst , param , cbnew){ // remote to locla
             // src file , dest file // must be files both not just dir
            var cb=function(){}            

            var opts={
                host: '127.0.0.1',
                port: '22',
                //username: '',
                //password: '' 
            }

            if (!_.isUndefined(param) ){
                	if (_.isFunction(param)){
                        cb=param
                    }
                    if (_.isPlainObject (param)){
                        //cb=param
                        if (_.isPlainObject (param.ftp)){
                            opts=param.ftp
                            console.log("ftp opts set")
                        }
                    }
            }
            if (!_.isUndefined(cbnew) ){
                if (_.isFunction(cbnew)){
                    cb=cbnew 
                }
            }

            let sftp = new SFTPClient();
        
            sftp.connect(opts).then(() => {                
                    
                    sftp.fastGet(src, dst).then(() => {                    
                    cb()    
                    sftp.end();
                    
                }).catch((err) => {
                    cb(err)
                    sftp.end();
                    
                   
                })
        
                return {} 
            }).then(data => {                
            }).catch(err => {
                cb()
                console.log(err, 'ftp catch error');
            });
        
        
        }
        ,sftp_getDir : function(src , dst , param , cbnew){ // remote to locla        
           var cb=function(){}
           var opts={
               host: '127.0.0.1',
               port: '22',
               //username: '',
               //password: '' 
           }

           if (!_.isUndefined(param) ){
                   if (_.isFunction(param)){
                       cb=param
                   }
                   if (_.isPlainObject (param)){
                       //cb=param
                       if (_.isPlainObject (param.ftp)){
                           opts=param.ftp
                           console.log("ftp opts set")
                       }
                   }
           }
           if (!_.isUndefined(cbnew) ){
               if (_.isFunction(cbnew)){
                   cb=cbnew 
               }
           }

           let sftp = new SFTPClient();
       
           sftp.connect(opts).then(() => {                                  
                sftp.downloadDir(src, dst).then(() => {                   
                   cb()    
                   sftp.end();                   
               }).catch((err) => {
                   cb(err)
                   sftp.end();                  
               })       
               return {} 
           }).then(data => {
               //cb()
               //console.log(data, 'the data info');
           }).catch(err => {
               cb()
               console.log(err, 'ftp catch error');
           });
       
       
       }
        ,sftp_put : function(src , dst , param , cbnew){ // local to remote
            // src file , dest file // must be files both not just dir
           var cb=function(){}

           var opts={
               host: '127.0.0.1',
               port: '22',
               //username: '',
               //password: '' 
           }

           if (!_.isUndefined(param) ){
                   if (_.isFunction(param)){
                       cb=param
                   }
                   if (_.isPlainObject (param)){
                       if (_.isPlainObject (param.ftp)){
                           opts=param.ftp
                           console.log("ftp opts set")
                       }
                   }
           }
           if (!_.isUndefined(cbnew) ){
               if (_.isFunction(cbnew)){
                   cb=cbnew 
               }
           }
           let sftp = new SFTPClient();
       
           sftp.connect(opts).then(() => {            
                sftp.fastPut(src, dst).then(() => {                   
                   cb()    
                   sftp.end();
                   
               }).catch((err) => {
                   cb(err)
                   sftp.end();
                   //console.log(err, 'fastGet method error');                  
               })
       
               return {} 
           }).then(data => {
               //cb()
               //console.log(data, 'the data info');
           }).catch(err => {
               cb()
               console.log(err, 'ftp catch error');
           });
       
       
        }
        ,sftp_putDir : function(src , dst , param , cbnew){ // local to remote
            // src file , dest file // must be files both not just dir
           var cb=function(){}

           var opts={
               host: '127.0.0.1',
               port: '22',
               //username: '',
               //password: '' 
           }

           if (!_.isUndefined(param) ){
                   if (_.isFunction(param)){
                       cb=param
                   }
                   if (_.isPlainObject (param)){
                       //cb=param
                       if (_.isPlainObject (param.ftp)){
                           opts=param.ftp
                           console.log("ftp opts set")
                       }
                   }
           }
           if (!_.isUndefined(cbnew) ){
               if (_.isFunction(cbnew)){
                   cb=cbnew 
               }
           }

           let sftp = new SFTPClient();
       
           sftp.connect(opts).then(() => {                   
                sftp.uploadDir(src, dst).then(() => {                   
                   cb()    
                   sftp.end();
                   
               }).catch((err) => {
                   cb(err)
                   sftp.end();
                   //console.log(err, 'fastGet method error');                  
               })
       
               return {} 
           }).then(data => {
               //cb()
               //console.log(data, 'the data info');
           }).catch(err => {
               cb()
               console.log(err, 'ftp catch error');
           });
       
       
        }
        ,sftp_list : function(src , dst , param , cbnew){ // local to remote
            // src file , dest file // must be files both not just dir
           var cb=function(){}

           var opts={
               host: '127.0.0.1',
               port: '22',
               //username: '',
               //password: '' 
           }

           if (!_.isUndefined(param) ){
                   if (_.isFunction(param)){
                       cb=param
                   }
                   if (_.isPlainObject (param)){
                       //cb=param
                       if (_.isPlainObject (param.ftp)){
                           opts=param.ftp
                           console.log("ftp opts set")
                       }
                   }
           }
           if (!_.isUndefined(cbnew) ){
               if (_.isFunction(cbnew)){
                   cb=cbnew 
               }
           }

           let sftp = new SFTPClient();
       
           sftp.connect(opts).then(() => {
       
               return sftp.list()
           }).then(data => {
               cb(data)
               //console.log(data, 'the data info');
           }).catch(err => {
               cb()
               console.log(err, 'ftp catch error');
           });       
        }

        ,uuid_sort : function(arr){
                /* to use example
                var uuid_a=[uuid(),uuid(),uuid() ]
                uuid_r=[uuid_a[1],uuid_a[2],uuid_a[0]]
                console.log(uuid_r);
                console.log ( 'sorted' , uuid_sort(uuid_r) )
                */
                var toSortableUUID=function(uuidV1){
                return uuidV1.replace(/^(.{8})-(.{4})-(.{4})/, '$3-$2-$1')
                }
                var uuidCompare=function(uuidV1A, uuidV1B)  {
                if (uuidV1A === uuidV1B) {
                    return 0;
                }
                const a = toSortableUUID(uuidV1A);
                const b = toSortableUUID(uuidV1B);
                return a < b ? -1 : 1;
                }
        }
        ,sdate : function(){
                var l_date;
                l_date=moment().format("DD-MM-YYYY");
                return l_date;
        }
        ,stime : function(){
                var l_time;
                l_time=moment().format( "HH:mm.ss");
                return l_time
        }
        ,uuid : uuid

        ,autoLoadModules: function (fpath) {    
            var mds={};
            var skip_exp_name=false;
            if ( !_.isUndefined(arguments[1]) ){
                skip_exp_name=arguments[1]
            }
        
            var stat=fs.lstatSync(fpath);
            if (stat.isDirectory()) {
                // we have a directory: do a tree walk
                var files=fs.readdirSync(fpath);
                var f, l = files.length;
                for (var i = 0; i < l; i++) {
                    f = path.join(fpath, files[i]);
                    if (f.endsWith(".js")){ 
                        //console.log("require( " , f , " )")
                        var temp=require(f)
                        //mds[f.replace("\.js", "")]=
                        if (skip_exp_name ){ // dont use export name , just use export library values id object has been exported 
                            if ( _.isPlainObject(temp)){
                                _.each(temp, function(val,prop){                
                                    _.each(val, function(val2,prop2){
                                        mds[prop2]=val2
                                    })
                                })
                            }else{
                                _.each(temp, function(val,prop){                
                                    mds[prop]=val                    
                                })
                            }
                            
                        }else{
                            _.each(temp, function(val,prop){                
                                mds[prop]=val
                                //console.log(prop)
                                if (!_.isUndefined(mds[prop]["auto_run"] )){
                                    mds[prop]["auto_run"]()
                                };
                            })
                        }
                    
                    
            
                    }
                }
            }
            return mds;
        }

        ,init : function(){
            var args=arguments;
            var args_l=args.length;
            var param={ name : "" }

            this.l_this=this ;

            if ( args_l > 0 ){
                if ( _.isPlainObject(args[0] )){
                    if (!_.isUndefined(args[0].name)){
                        param.name=args[0].name;
                    }
                }
                if ( _.isString(args[0] )){
                    param.name=args[0];
                }
            }

            this.name=param.name;




        }
    }
    l_this.init.apply( l_this , arguments) ;
    return l_this ;
}

var settings_file=function(){
    l_this = {
        name : "settings_file"

        ,path : "../data/settings.json"

        ,data : {}
        ,getfile : function(){
            var nd_generated_setup_path=path.resolve( "../data/settings.json");            

            var file_data_s=fs.readFileSync( nd_generated_setup_path , 'utf8');
            var file_data_jsn=JSON.parse(file_data_s);


            var vserv={};
            
            vserv.host=file_data_jsn.host;
          
            vserv.port=file_data_jsn.port;

            vserv.name=file_data_jsn.name;

            vserv.jwt_secret="jwtSecret_randomtest1244"; //#todo set in settings/env file - sec priority
            vserv.cookieSecret="some_secret_1234"     //#todo set in settings/env file - sec priority
            vserv.debugmode=file_data_jsn.debugmode;
            vserv.debuglevels=file_data_jsn.debuglevels;

            vserv.env_type=file_data_jsn.env_type;
                env_type=vserv.env_type;

            vserv.httpProtoString=file_data_jsn.httpProtoString;
            var ishttps=false;
            if (vserv.httpProtoString==="https"){
                ishttps=true;    
            }
            vserv.sslkey=file_data_jsn.sslkey;
            vserv.sslkeysslcert=file_data_jsn.sslcert;

            vserv.systems=file_data_jsn.systems;
            vserv.system=file_data_jsn.system;

            vserv.show_settings=file_data_jsn.show_settings;
            vserv.show_codenote=file_data_jsn.show_codenote;
            vserv.show_note=file_data_jsn.show_note;

            var tempjson_file_data_jsn=_.clone(file_data_jsn);
            if (vserv.show_settings){  
                delete tempjson_file_data_jsn.codenote;
                delete tempjson_file_data_jsn.note;
                console.log(tempjson_file_data_jsn)
            }

            if (vserv.show_codenote){       
                console.log(file_data_jsn.codenote)
            }

            if (vserv.show_note){      
                console.log( "\nnote : \n" , file_data_jsn.note , "\n")
            }

            if (!_.isUndefined(file_data_jsn.fsusers)){
                vserv.users=file_data_jsn.fsusers
            }else{ vserv.users={}}

            this.data=vserv;

        }
    
        ,init : function(){
            var args=arguments;
            var args_l=args.length;
            var param={ name : "" }

            this.l_this=this ;

            if ( args_l > 0 ){
                if ( _.isPlainObject(args[0] )){
                    if (!_.isUndefined(args[0].name)){
                        param.name=args[0].name;
                    }
                    if (!_.isUndefined(args[0].path)){
                        param.path=args[0].path;
                    }
                }
                if ( _.isString(args[0] )){
                    param.name=args[0];
                }
            }

            this.name=param.name;
            this.path=param.path;


            this.getfile()

        }
    }
    l_this.init.apply( l_this , arguments) ;
    return l_this ;
}

module.exports.gl=new vrtstd();
module.exports.settings=settings_file;
